{% load custom_filters %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mediciones de {{ obra.nombre }}</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <style>
        body { font-family: sans-serif; margin: 2em; line-height: 1.6; }
        h1 { color: #333; }
        .btn-container { margin-bottom: 1em; }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin-right: 10px;
        }
        .btn:hover { background-color: #0056b3; }
        .mediciones-table {
            width: 0 auto;
            border-collapse: collapse;
            margin-top: 1em;
        }
        .mediciones-table th, .mediciones-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .mediciones-table th { background-color: #f2f2f2; }
        .mediciones-table td { background-color: #fff; }
        .measurement-input { width: 80px; }
        
        /* Estilos específicos para DataTables */
        .dataTables_wrapper .dataTables_filter { text-align: right; }
        .dataTables_wrapper .dataTables_paginate { float: right; }
        
        /* Estilos para el título de la fase y tarea dentro de la tabla */
        .phase-header { background-color: #e9ecef; font-weight: bold; }
        .task-header { background-color: #f8f9fa; font-weight: bold; padding-left: 20px !important; }

        .chart-container {
            margin-top: 2em;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body>
    <h1>Mediciones de Obra para: {{ obra.nombre }}</h1>
    <div class="btn-container">
        <a href="{% url 'obra-detail' obra.pk %}" class="btn">Volver a la Obra</a>
    </div>

    <form method="post">
        {% csrf_token %}
        <div class="form-group">
            <label for="id_fecha_medicion">Fecha de Medición:</label>
            <input type="date" id="id_fecha_medicion" name="fecha_medicion" required>
        </div>
        <button type="submit" class="btn">Guardar Mediciones</button>
        <table id="mediciones-table" class="display mediciones-table">
            <thead>
                <tr>
                    <th colspan="2">Información y Avance</th>
                    <th>Cantidad Requerida</th>
                    {% for fecha in fechas_medicion %}
                        <th class="text-center">{{ fecha|date:"d M Y" }}</th>
                    {% endfor %}
                    <th>Medición Actual</th>
                </tr>
            </thead>
            <tbody>
                <!-- Los datos se insertarán aquí dinámicamente con JavaScript -->
            </tbody>
        </table>
    </form>
    
    <div class="chart-container">
        <h2>Avance por Fase (%)</h2>
        <canvas id="progressChart"></canvas>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
    $(document).ready(function() {
        // Carga los datos desde el contexto de Django
        const medicionesData = JSON.parse('{{ tabla_mediciones_json|safe }}');
        const fechasMedicion = JSON.parse('{{ fechas_medicion_json|safe }}');
        
        // Renderiza la tabla con los datos agrupados
        let htmlContent = '';
        let currentPhase = null;
        let currentTask = null;
        
        medicionesData.forEach(item => {
            // Check for new phase
            if (item.fase_nombre !== currentPhase) {
                htmlContent += `<tr class="phase-header"><td colspan="${5 + fechasMedicion.length}">Fase: ${item.fase_nombre}</td></tr>`;
                currentPhase = item.fase_nombre;
                currentTask = null; // Reset task when phase changes
            }

            // Check for new task
            if (item.tarea_nombre !== currentTask) {
                htmlContent += `<tr class="task-header"><td colspan="${5 + fechasMedicion.length}">Tarea: ${item.tarea_nombre}</td></tr>`;
                currentTask = item.tarea_nombre;
            }
            
            // Generate material rows
            let medicionesHtml = '';
            fechasMedicion.forEach(fecha => {
                const medicion = item.mediciones[fecha] || '-';
                medicionesHtml += `<td class="text-center">${medicion}</td>`;
            });

            htmlContent += `
                <tr>
                    <td colspan="2">${item.material_nombre}</td>
                    <td>${item.cantidad_requerida} ${item.material_unidad}</td>
                    ${medicionesHtml}
                    <td>
                        <input type="number" step="0.01"
                               class="measurement-input"
                               name="medicion-${item.tarea_pk}-${item.material_pk}"
                               value=""
                               placeholder="Cantidad">
                    </td>
                </tr>
            `;
        });
        
        $('#mediciones-table tbody').html(htmlContent);
        
        $('#mediciones-table').DataTable({
            "paging": true,
            "ordering": false,
            "searching": true,
            "info": true,
            "columnDefs": [
                { "orderable": false, "targets": '_all' }
            ]
        });

        // Lógica del gráfico de avance de la obra
        const totalAvancePorFase = {};
        const totalRequeridoPorFase = {};

        // Se usa la última fecha de medición para calcular el avance
        const ultimaFecha = fechasMedicion.length > 0 ? fechasMedicion[fechasMedicion.length - 1] : null;

        medicionesData.forEach(item => {
            const fase = item.fase_nombre;
            const cantidadRequerida = parseFloat(item.cantidad_requerida);
            
            // Solo se calcula el avance si hay una última fecha de medición
            const ultimaMedicion = ultimaFecha ? (parseFloat(item.mediciones[ultimaFecha]) || 0) : 0;

            if (cantidadRequerida > 0) {
                totalAvancePorFase[fase] = (totalAvancePorFase[fase] || 0) + ultimaMedicion;
                totalRequeridoPorFase[fase] = (totalRequeridoPorFase[fase] || 0) + cantidadRequerida;
            }
        });
        
        const fases = Object.keys(totalRequeridoPorFase);
        const avances = fases.map(fase => {
            const avance = totalAvancePorFase[fase] || 0;
            const requerido = totalRequeridoPorFase[fase];
            return requerido > 0 ? ((avance / requerido) * 100).toFixed(2) : 0;
        });

        // Solo se renderiza el gráfico si hay datos de avance
        if (fases.length > 0) {
            const ctx = document.getElementById('progressChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: fases,
                    datasets: [{
                        label: 'Porcentaje de Avance',
                        data: avances,
                        backgroundColor: (context) => {
                            const value = context.raw;
                            if (value >= 100) {
                                return 'rgba(75, 192, 192, 0.7)'; // Verde para 100%
                            } else if (value > 50) {
                                return 'rgba(255, 206, 86, 0.7)'; // Amarillo para > 50%
                            } else {
                                return 'rgba(255, 99, 132, 0.7)'; // Rojo para < 50%
                            }
                        },
                        borderColor: (context) => {
                            const value = context.raw;
                            if (value >= 100) {
                                return 'rgba(75, 192, 192, 1)';
                            } else if (value > 50) {
                                return 'rgba(255, 206, 86, 1)';
                            } else {
                                return 'rgba(255, 99, 132, 1)';
                            }
                        },
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Hace las barras horizontales para simular un Gantt
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Porcentaje (%)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Fase de la Obra'
                            }
                        }
                    },
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw + '%';
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
    });
    </script>
</body>
</html>