{% extends 'project_app/base.html' %}
{% load static %}

{% block title %}Crear Tarea{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
<style>
    .container-tarea {
        width: 98vw;
        max-width: 98vw;
        height: 80vh;
        max-height: 80vh;
        margin: 30px auto;
        background: rgba(255,255,255,0.13);
        border-radius: 10px;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255,255,255,0.1);
        box-shadow: 0 0 40px rgba(8,7,16,0.6);
        padding: 30px 20px;
        color: #fff;
    }
    .tarea-flex {
        display: flex;
        gap: 2em;
        width: 100%;
        align-items: flex-start;
    }
    .form-section {
        flex: 1 1 45%;
        margin-bottom: 0;
        padding: 1em;
        border-radius: 8px;
        background: rgba(255,255,255,0.08);
        min-width: 340px;
        max-width: 600px;
    }
    .materials-table-container {
        flex: 1 1 55%;
        max-height: 500px;
        overflow-y: auto;
        background: transparent !important;
        border-radius: 8px;
        padding: 1em;
        min-width: 340px;
    }
    .materials-table-container table {
        width: 100%;
    }

    form .user-details .input-box {
    margin-bottom: 15px;
    width: 100%;
    }

/* Scrollbar styles to match the glassmorphism theme */
.materials-table-container::-webkit-scrollbar {
    width: 10px;
    height: 8px;
    background: transparent;
}

.materials-table-container::-webkit-scrollbar-thumb {
    background: rgba(131, 131, 131, 0.2);
    border-radius: 6px;
    border: 2px solid transparent;
    background-clip: padding-box;
}

.btn-container {
    margin-top: 10px;
}

</style>
{% endblock %}

{% block content %}
<div class="container-tarea">
    <form method="post">
        {% csrf_token %}
        <div class="tarea-flex">
            <div class="user-details">
                <h2 class="title">Crear Tarea para la Fase: {{ fase.nombre }}</h2>
                <div class="input-box">
                    <span class="details">Nombre de la Tarea</span>
                    {{ form.nombre }}
                </div>

                <div class="input-box">
                    <span class="details">Descripción</span>
                    {{ form.descripcion }}
                </div>

                <div class="input-box">
                    <span class="details">Fecha de Inicio</span>
                    {{ form.fecha_inicio }}
                </div>

                <div class="input-box">
                    <span class="details">Fecha de Fin (Estimada)</span>
                    {{ form.fecha_fin_estimada }}
                </div>
            </div>

            <div class="user-details">
                <h2>Requerimientos de Materiales</h2>
                <p>Introduce la cantidad requerida para cada material.</p>
                <div class="materials-table-container">
                    <table id="materialsTable" class="display">
                        <thead>
                            <tr>
                                <th><input type="text" placeholder="Código" /></th>
                                <th>Material</th>
                                <th>Unidad</th>
                                <th>Cantidad Requerida</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for material in materiales %}
                                <tr>
                                    <td>{{ material.codigo }}</td>
                                    <td>{{ material.nombre }}</td>
                                    <td>{{ material.unidad }}</td>
                                    <td>
                                        <input type="number" 
                                               step="0.01" 
                                               name="material-quantity-{{ material.pk }}" 
                                               min="0"
                                               class="input-cantidad">
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="btn-container">
            <button type="submit" class="btn">Guardar Tarea</button>
            <a href="{% url 'obra-detail' pk=fase.obra.pk %}" class="btn">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
<script>
    $(document).ready(function() {
        var table = $('#materialTable').DataTable({
            "language": {
                "url": "https://cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json"
            },
            "scrollY": "54vh",
            "scrollCollapse": true,
            "paging": false, 
            "deferRender": true
        });

        table.columns().every(function() {
            var that = this;

            $('input', this.header()).on('keyup change', function() {
                if (that.search() !== this.value) {
                    that
                        .search(this.value)
                        .draw();
                }
            });
        });
    });
</script>
{% endblock %}
